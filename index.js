// 315793010 - id Ð¼Ð¾ÐµÐ³Ð¾ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°
import {
	getWeather,
	checkMessageDziba,
	checkMessageStrigoi,
	answerChatGpt,
	sendYou,
	getMotivationalQuote,
	getInterestingFact,
	getRandomGif,
} from "./modules/index.js";

import {Telegraf} from "telegraf";
import dotenv from "dotenv";

dotenv.config();

const testApiKey = process.env.TEST_BOT_API;

const bot = new Telegraf(testApiKey);
bot.start((ctx) => ctx.reply("ÐŸÑ€Ð¸Ð²ÐµÑ‚!"));
bot.hears("/random", (ctx) =>
{
	let randomId = Math.floor(Math.random() * 300);
	ctx.reply(`https://picsum.photos/id/${randomId}/400/600/`);
});

bot.command("weather", (ctx) =>
{
	const location = "Vladikavkaz";
	getWeather(location, ctx);
});

bot.command("fact", async (ctx) =>
{
	try
	{
		const fact = await getInterestingFact();
		ctx.reply(fact);
	}
	catch (error)
	{
		console.error(error);
		ctx.reply("ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð· Ð¿Ð¾Ð·Ð´Ð½ÐµÐµ");
	}
});

bot.command("gif", async (ctx) =>
{
	try
	{
		const query = ctx.message.text.split(" ").slice(1).join(" ");
		const gifUrl = await getRandomGif(query);
		
		ctx.replyWithAnimation({url: gifUrl});
	}
	catch (error)
	{
		console.error(error);
		ctx.reply("ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð· Ð¿Ð¾Ð·Ð´Ð½ÐµÐµ");
	}
});

bot.command("quote", async (ctx) =>
{
	try
	{
		const quote = await getMotivationalQuote();
		console.log(quote);
		
		ctx.reply(quote.quoteText);
		if (quote.quoteAuthor)
		{
			ctx.reply(quote.quoteAuthor);
		}
	}
	catch (error)
	{
		console.error(error);
		ctx.reply("ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð· Ð¿Ð¾Ð·Ð´Ð½ÐµÐµ");
	}
});

bot.on("sticker", (ctx) =>
{
	if (ctx.message.sticker.emoji === "ðŸ‘")
	{
		ctx.reply("ðŸ‘Œ");
	}
});
// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on("message", (ctx) =>
{
	// sendYou(ctx);
	// checkMessageDziba(ctx);
	// checkMessageStrigoi(ctx);
	answerChatGpt(ctx);
});

// Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÐµÐ¹
let articles = [];

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ð°Ñ‚ÑŒÐ¸
function createArticle(title, content)
{
	const newArticle = {title, content};
	articles.push(newArticle);
	return newArticle;
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑÑ‚Ð°Ñ‚ÑŒÐ¸
function editArticle(index, newTitle, newContent)
{
	if (index >= 0 && index < articles.length)
	{
		articles[index].title = newTitle;
		articles[index].content = newContent;
		return true;
	}
	return false;
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼
async function isAdmin(ctx)
{
	const chatMember = await ctx.getChatMember(ctx.from.id);
	return chatMember.status === "creator" || chatMember.status === "administrator";
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.start((ctx) =>
{
	ctx.reply("Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ! Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ /create Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑŒÐ¸ Ð¸Ð»Ð¸ /edit Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑŒÐ¸.");
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /create
bot.command("create", async (ctx) =>
{
	if (await isAdmin(ctx))
	{
		ctx.reply("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑŒÐ¸:");
		bot.on("text", (ctx) =>
		{
			const title = ctx.message.text;
			ctx.reply("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑŒÐ¸:");
			bot.on("text", (ctx) =>
			{
				const content = ctx.message.text;
				createArticle(title, content);
				ctx.reply("Ð¡Ñ‚Ð°Ñ‚ÑŒÑ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð°!");
			});
		});
	}
	else
	{
		ctx.reply("Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑŒÐ¸.");
	}
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /edit
bot.command("edit", async (ctx) =>
{
	if (await isAdmin(ctx))
	{
		ctx.reply("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð½Ð´ÐµÐºÑ ÑÑ‚Ð°Ñ‚ÑŒÐ¸ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:");
		bot.on("text", (ctx) =>
		{
			const index = parseInt(ctx.message.text);
			ctx.reply("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ð¾Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑŒÐ¸:");
			bot.on("text", (ctx) =>
			{
				const newTitle = ctx.message.text;
				ctx.reply("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑŒÐ¸:");
				bot.on("text", (ctx) =>
				{
					const newContent = ctx.message.text;
					if (editArticle(index, newTitle, newContent))
					{
						ctx.reply("Ð¡Ñ‚Ð°Ñ‚ÑŒÑ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°!");
					}
					else
					{
						ctx.reply("ÐžÑˆÐ¸Ð±ÐºÐ°: Ð½ÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¸Ð½Ð´ÐµÐºÑ ÑÑ‚Ð°Ñ‚ÑŒÐ¸.");
					}
				});
			});
		});
	}
	else
	{
		ctx.reply("Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑŒÐ¸.");
	}
});


// const rubai = ["Ñ€ÑƒÐ±Ð°Ð¹", "Ñ€ÑƒÐ±Ð°Ð¹.", "Ñ€ÑƒÐ±Ð°Ð¹,", "Ñ€ÑƒÐ±Ñ", "Ñ€ÑƒÐ±ÐµÐ½Ñ", "rubai", "rubs", "rubens", "Ð ÑƒÐ±Ð°Ð¹", "Ð ÑƒÐ±Ð°Ð¹.",
// "Ð ÑƒÐ±Ð°Ð¹,", "Ð ÑƒÐ±Ñ", "Ð ÑƒÐ±ÐµÐ½Ñ", "Rubai", "Rubs", "Rubens", "Ñ€ÑƒÐ±Ñ‡Ð¸Ðº"]; const sirena = ["@news_sirena",
// "@sirenanews_bot"];


// function to send the New Year's greeting
async function sendMessage()
{
	await bot.telegram.sendMessage(-1001695052259, "Ðž, Ñ Ð½Ð¾Ð²Ñ‹Ð¼ Ð³Ð¾Ð´Ð¾Ð¼ Ð¿Ð°Ñ†Ð°Ð½Ñ‹!!! ðŸŽ‰ðŸŽŠðŸŽˆ");
}

// Schedule the sendMessage function to run every day at 00:00
const now = new Date();
// Calculate the time until midnight
const timeUntilMidnight = (24 - now.getHours()) * 60 * 60 * 1000 + (60 - now.getMinutes()) * 60 * 1000 + (60 - now.getSeconds()) * 1000;
// Schedule the sendMessage function to run at midnight
setTimeout(() =>
{
	setInterval(sendMessage, 24 * 60 * 60 * 1000);
}, timeUntilMidnight);


// async function checkMessageFromUser(ctx)
// {
// 	const message = ctx.update.message;
// 	if(message.forward_from_chat)
// 	{
// 		if(message.forward_from_chat.id === -1001607140386)
// 		{
// 			await ctx.telegram.deleteMessage(message.chat.id, message.message_id);
// 			ctx.reply("This message has been deleted due to spreading fake information. SIRENA BAD!");
// 		}
// 	}
// }

// async function checkMessageFromRubai(ctx)
// {
// 	let message = ctx.update.message;
// 	if(message.text && sirena.some((word) => message.text.includes(word)))
// 	{
// 		await ctx.telegram.deleteMessage(message.chat.id, message.message_id);
// 		ctx.reply("This message has been deleted due to spreading fake information. SIRENA BAD!");
// 	}
// }

// async function checkRubai(ctx)
// {
// 	const message = ctx.update.message;
// 	if (message.text && rubai.some((word) => message.text.includes(word)))
// 	{
// 		await ctx.telegram.sendAudio(ctx.message.chat.id, {source: "strigoi.mp3"}, {reply_to_message_id:
// ctx.message.message_id}); } }

bot.launch();
